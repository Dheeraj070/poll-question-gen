name: Connect to Ollama via Tailscale

on:
  push:
    branches: [main, test-cicd]
    paths:
      - 'backend/**'
      - '.github/workflows/ollama-ci.yml'
  workflow_dispatch:
    
jobs:
  call-ollama:
    runs-on: ubuntu-latest

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Authenticate Tailscale
        run: |
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }} --ssh
          echo "Tailscale connected"
          tailscale status

      - name: Wait for Tailscale connection
        run: sleep 5

      - name: Test connection to Ollama
        run: |
          echo "Pinging Ollama server..."
          curl --fail http://100.100.108.13:11434/api/tags || (echo "Failed to connect to Ollama"; exit 1)

